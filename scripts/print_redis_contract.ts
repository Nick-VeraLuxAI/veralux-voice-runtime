import fs from "node:fs";
import path from "node:path";

const reportLines = [
  "# Redis Contract Consumption Report",
  "",
  "Generated by `scripts/print_redis_contract.ts`.",
  "",
  "## Scope",
  "- Redis usage in `src/tenants/tenantResolver.ts`, `src/tenants/tenantConfig.ts`, and `src/limits/capacity.ts`.",
  "",
  "## Redis-related environment variables",
  "- `REDIS_URL` (required; startup throws if missing)",
  "- `TENANTMAP_PREFIX` (default `tenantmap` when missing/blank)",
  "- `TENANTCFG_PREFIX` (default `tenantcfg` when missing/blank)",
  "- `CAP_PREFIX` (default `cap` when missing/blank)",
  "- `GLOBAL_CONCURRENCY_CAP` (required)",
  "- `TENANT_CONCURRENCY_CAP_DEFAULT` (required)",
  "- `TENANT_CALLS_PER_MIN_CAP_DEFAULT` (required)",
  "- `CAPACITY_TTL_SECONDS` (required)",
  "",
  "## Tenant DID -> tenantId mapping",
  "- Key format: `${TENANTMAP_PREFIX}:did:${normalized}`",
  "- Normalization: trim + remove internal whitespace; validate E.164 (`/^\\+[1-9]\\d{1,14}$/`), invalid => empty.",
  "- Lookup: `GET` on the key; returns `tenantId` string or `null`.",
  "",
  "## Tenant runtime config (tenantcfg)",
  "- Key format: `${TENANTCFG_PREFIX}:${tenantId}`",
  '- Schema version: `contractVersion: "v1"`',
  "- Required fields: `contractVersion`, `tenantId`, `dids`, `caps`, `stt`, `tts`, `audio`, plus `webhookSecretRef` or `webhookSecret`.",
  "- caps: `maxConcurrentCallsTenant`, `maxCallsPerMinuteTenant`, optional `maxConcurrentCallsGlobal`.",
  '- stt: `mode: "whisper_http"`, `whisperUrl`, `chunkMs`, optional `language`.',
  '- tts: `mode: "kokoro_http"`, `kokoroUrl`, optional `voice`, `format`, `sampleRate`.',
  "- audio: optional `publicBaseUrl`, `storageDir`, `runtimeManaged`.",
  "- dids: each DID must be valid E.164.",
  "",
  "Example JSON:",
  "```json",
  "{",
  '  "contractVersion": "v1",',
  '  "tenantId": "tenant_123",',
  '  "dids": ["+14155550123"],',
  '  "webhookSecret": "telnyx-webhook-secret",',
  '  "caps": {',
  '    "maxConcurrentCallsTenant": 10,',
  '    "maxCallsPerMinuteTenant": 120,',
  '    "maxConcurrentCallsGlobal": 200',
  "  },",
  '  "stt": {',
  '    "mode": "whisper_http",',
  '    "whisperUrl": "https://stt.internal/v1/whisper",',
  '    "chunkMs": 800,',
  '    "language": "en"',
  "  },",
  '  "tts": {',
  '    "mode": "kokoro_http",',
  '    "kokoroUrl": "https://tts.internal/v1/kokoro",',
  '    "voice": "alloy",',
  '    "format": "wav",',
  '    "sampleRate": 24000',
  "  },",
  '  "audio": {',
  '    "publicBaseUrl": "https://media.example.com/audio",',
  '    "storageDir": "/var/lib/voice/audio",',
  '    "runtimeManaged": true',
  "  }",
  "}",
  "```",
  "",
  "Config usage:",
  "- `caps` provide per-tenant default limits; Redis override keys still win.",
  "- `stt` overrides Whisper URL, chunk size, and optional language query param.",
  "- `tts` overrides Kokoro URL, voice, format, and sample rate.",
  "- `webhookSecretRef`/`webhookSecret` are required by schema but not used for signature verification yet.",
  "",
  "## Capacity limiting keys",
  "- Global active set: `${CAP_PREFIX}:global:active`",
  "- Tenant active set: `${CAP_PREFIX}:tenant:${tenantId}:active`",
  "- Tenant RPM counter: `${CAP_PREFIX}:tenant:${tenantId}:rpm:${YYYYMMDDHHmm}` (UTC timestamp; zero-padded year/month/day/hour/minute)",
  "- Tenant concurrency cap override: `${TENANTMAP_PREFIX}:tenant:${tenantId}:cap:concurrency`",
  "- Tenant RPM cap override: `${TENANTMAP_PREFIX}:tenant:${tenantId}:cap:rpm`",
  "",
  "Read behavior:",
  "- `cap:concurrency` and `cap:rpm` are read via `GET`. Values must parse to positive numbers; otherwise defaults are used.",
  "",
  "Write behavior:",
  "- Active sets are updated with `SADD`/`EXPIRE` (TTL = `CAPACITY_TTL_SECONDS`).",
  "- RPM key is `INCR`'d and `EXPIRE`'d for 120 seconds when first created.",
  "",
  "## Failure behaviors and logs",
  '- DID mapping missing (`GET` returns null or normalized number is empty): `resolveTenantId` returns `null`; `call.initiated` plays "The number you dialed is not configured." then hangs up. No explicit log for missing mapping.',
  "- Redis down during tenant mapping: `resolveTenantId` logs `tenant resolve failed`, then treats as missing mapping (same message + hangup).",
  '- Tenantcfg missing/invalid: `loadTenantConfig` returns null; `call.initiated` plays "This number is not fully configured." then hangs up.',
  "- Redis down during tenantcfg fetch: logs `tenant config fetch failed`, then treated as missing.",
  "- Redis down during capacity check:",
  "  - `tryAcquire` logs `capacity evaluation failed` and throws.",
  '  - `telnyxWebhook` logs `capacity check failed`, plays "We are unable to accept your call right now.", then hangs up.',
  "- At capacity (script returns `global_at_capacity`, `tenant_at_capacity`, or `tenant_rate_limited`):",
  "  - `tryAcquire` logs `capacity denied`.",
  '  - `telnyxWebhook` plays "We are currently at capacity. Please try again later." then hangs up.',
  "- Redis down during capacity release: logs `capacity release failed` but call teardown continues.",
  "- HTTP behavior: webhook handler responds `200 { ok: true }` after enqueuing work (only invalid signature returns 401); failures are handled asynchronously and do not return 4xx/5xx to Telnyx.",
  "- Redis client behavior: uses `maxRetriesPerRequest: 2` and `enableReadyCheck: true`; no explicit per-request timeout is set in code.",
];

const report = reportLines.join("\n");
const output = report.endsWith("\n") ? report : `${report}\n`;

const docsDir = path.join(process.cwd(), "docs");
const outputPath = path.join(docsDir, "redis_contract_report.md");

fs.mkdirSync(docsDir, { recursive: true });
fs.writeFileSync(outputPath, output, "utf8");

process.stdout.write(output);
