# File Guide

This guide maps files to responsibilities and shows how the runtime fits together.

## Architecture at a glance

PSTN / Telnyx call flow:
- Telnyx webhooks hit `src/routes/telnyxWebhook.ts`, which verifies signatures (`src/telnyx/telnyxVerify.ts`), resolves tenants (`src/tenants/*`), and enforces capacity (`src/limits/capacity.ts`).
- Sessions are created and queued in `src/calls/sessionManager.ts`, which owns `src/calls/callSession.ts` and transports (`src/transport/pstnTelnyxTransport.ts`).
- Telnyx media arrives over the WebSocket in `src/server.ts`, which hands frames to `src/media/mediaIngest.ts` for payload selection and decoding via `src/audio/codecDecode.ts`.
- Decoded PCM flows into `CallSession` -> `src/stt/chunkedSTT.ts` -> `src/stt/registry.ts` -> `src/stt/providers/*`.
- Transcript -> `src/ai/brainClient.ts` (fallback `src/ai/defaultBrain.ts`) -> `src/tts/kokoroTTS.ts` -> `src/audio/playbackPipeline.ts` -> `src/storage/audioStore.ts` -> `src/telnyx/telnyxClient.ts` for playback.
- Diagnostics and timing are collected in `src/diagnostics/audioProbe.ts` and `src/metrics.ts`.

WebRTC HD flow:
- `/v1/webrtc/offer` in `src/routes/webrtc.ts` accepts SDP and creates a `src/transport/webrtcHdTransport.ts` session.
- The WebRTC session is registered via `src/calls/sessionManager.ts` and shares the same STT/brain/TTS pipeline as PSTN.

## File map

### Top-level files
- `README.md` - repository overview and basic usage.
- `LICENSE` - project license.
- `.env` - local runtime environment overrides.
- `.env.example` - example env file with required variables.
- `.eslintrc.cjs` - ESLint configuration.
- `.prettierrc` - Prettier configuration.
- `.prettierignore` - Prettier ignore list.
- `.gitignore` - Git ignore list.
- `.github/workflows/ci.yml` - CI pipeline (lint, typecheck, build, test).
- `docker-compose.yml` - local Docker services (Redis).
- `package.json` - dependencies and npm scripts.
- `package-lock.json` - npm lockfile.
- `tsconfig.json` - TypeScript compiler config.
- `docs/` - documentation files (see below).
- `public/` - static assets served by the runtime (see below).
- `scripts/` - dev and ops scripts (see below).
- `src/` - runtime source code (see below).
- `tests/` - unit tests (see below).
- `dist/` - compiled output (generated).
- `node_modules/` - installed dependencies (generated).
- `oldenv.txt` - archived env configuration and notes.
- `phase 2.txt` - design prompt notes for the playback pipeline work.
- `serverlogs.txt` - saved log snapshot.
- `runtimeserverlogs.txt` - saved runtime log snapshot.
- `tenant.json` - placeholder tenant config (currently empty).
- `whisper_v3_HGt1287GjzqTRRtbkv4Rm3J2Y0sxUW7Kq1jIcHIws0ECWKRNogCgog_final_6_1768189914073.wav` - captured audio sample for debugging.

### docs/
- `docs/README.md` - documentation index.
- `docs/overview.md` - high-level runtime overview.
- `docs/architecture.md` - components and data flow.
- `docs/api.md` - HTTP and WebSocket API reference.
- `docs/configuration.md` - configuration and env variables.
- `docs/deployment.md` - deployment guidance.
- `docs/operations.md` - operational notes and runbooks.
- `docs/security.md` - security considerations and verification behavior.
- `docs/troubleshooting.md` - troubleshooting checklist.
- `docs/limitations.md` - known limitations.
- `docs/redis_contract_report.md` - Redis key contract report (generated by script).
- `docs/file-guide.md` - this guide.

### public/
- `public/hd-call.html` - minimal WebRTC test UI.
- `public/hd-call.js` - client-side WebRTC offer/answer flow.

### scripts/
- `scripts/dev_ngrok.sh` - prints webhook/media URLs from a running ngrok tunnel.
- `scripts/dev_redis.sh` - starts Redis via Docker Compose and prints `REDIS_URL`.
- `scripts/dump_mulaw_wav.ts` - generates a WAV from a sample mu-law payload.
- `scripts/print_redis_contract.ts` - generates `docs/redis_contract_report.md`.
- `scripts/self_check_contract.ts` - sanity checks tenantcfg schema and E.164 normalization.
- `scripts/smoke_load_tenantcfg.ts` - smoke test for tenantcfg read/write in Redis.
- `scripts/smoke_media_ws.js` - sends fake frames to the media WebSocket.
- `scripts/smoke_webhook.sh` - posts signed Telnyx webhook events.
- `scripts/telnyx_payload_inspect.ts` - inspects captured Telnyx payloads for format hints.
- `scripts/tenantcfg.ts` - CLI to read/update tenant configs in Redis.
- `scripts/whisper_replay.ts` - posts a WAV file to Whisper for replay/debug.

### src/entry and core
- `src/index.ts` - entrypoint that builds and starts the server.
- `src/server.ts` - Express + WebSocket server, routes, media ingest wiring, audio serving.
- `src/env.ts` - env schema validation and defaults.
- `src/log.ts` - Pino logger setup.
- `src/metrics.ts` - Prometheus metrics and middleware.

### src/ai
- `src/ai/brainClient.ts` - calls the brain service or falls back to local defaults.
- `src/ai/defaultBrain.ts` - rule-based fallback replies.

### src/calls
- `src/calls/types.ts` - call/session types and enums.
- `src/calls/callSession.ts` - per-call state machine, STT/TTS/brain orchestration.
- `src/calls/sessionManager.ts` - session registry, per-call queues, teardown logic.

### src/media
- `src/media/types.ts` - media frame and PCM frame types.
- `src/media/mediaIngest.ts` - Telnyx media ingestion, decoding, buffering, health checks.
- `src/media/mediaIngestcopy.ts` - older snapshot of media ingest logic.
- `src/media/streamIngest.ts` - simple media frame logger (non-Telnyx path).

### src/audio
- `src/audio/amrwbRtp.ts` - AMR-WB RTP stripping and repacking helpers.
- `src/audio/codecDecode.ts` - codec decoding to PCM16 and resampling utilities.
- `src/audio/codecDecodecopy.ts` - alternate decoder implementation (reference copy).
- `src/audio/debugAudioTap.ts` - rolling PCM capture and WAV dump for debugging.
- `src/audio/opusDecoder.ts` - Opus packet decoder wrapper (opusscript).
- `src/audio/playbackPipeline.ts` - TTS WAV post-processing for PSTN playback.
- `src/audio/postprocess.ts` - WAV encode/decode and PCM post-processing helpers.
- `src/audio/resample48kTo16k.ts` - fast 48kHz -> 16kHz downsample.
- `src/audio/wavInfo.ts` - WAV header parsing and summary stats.
- `src/audio/__tests__/amrwbRtp.test.ts` - AMR-WB RTP unit tests.

### src/audio/vendor (third-party codec helpers)
- `src/audio/vendor/amrwb/AmrWbDecoder.ts` - WASM-backed AMR-WB decoder wrapper.
- `src/audio/vendor/amrwb/amrwb.js` - Emscripten JS glue for AMR-WB.
- `src/audio/vendor/amrwb/amrwb.wasm` - AMR-WB decoder WASM binary.
- `src/audio/vendor/amrwb/amrwb.d.ts` - TypeScript types for AMR-WB module.
- `src/audio/vendor/amrwb/LICENSE` - AMR-WB vendor license.
- `src/audio/vendor/g722/g722.ts` - G.722 decoder implementation.
- `src/audio/vendor/g722/LICENSE` - G.722 vendor license.
- `src/audio/vendor/opus/OpusDecoder.ts` - WASM Opus decoder (browser-style).
- `src/audio/vendor/opus/EmscriptenWasm.ts` - Emscripten loader for Opus WASM.
- `src/audio/vendor/opus/WASMAudioDecoderCommon.ts` - shared WASM decoder utilities.
- `src/audio/vendor/opus/LICENSE` - Opus vendor license.

### src/diagnostics and observability
- `src/diagnostics/audioProbe.ts` - audio metadata tracking, probes, and spans.
- `src/observability/callLogs.ts` - structured call event logger.

### src/limits, redis, tenants
- `src/redis/client.ts` - Redis client singleton and factory.
- `src/limits/capacity.ts` - capacity enforcement via Redis Lua script.
- `src/tenants/tenantResolver.ts` - DID -> tenant lookup in Redis.
- `src/tenants/tenantConfig.ts` - tenantcfg schema and loader.

### src/routes
- `src/routes/health.ts` - health endpoint.
- `src/routes/telnyxWebhook.ts` - Telnyx webhook handler (verify, tenant, capacity, streaming).
- `src/routes/webrtc.ts` - WebRTC offer endpoint and session creation.

### src/stt
- `src/stt/chunkedSTT.ts` - speech chunking, endpointing, and STT orchestration.
- `src/stt/provider.ts` - STT provider interface.
- `src/stt/registry.ts` - provider selection and adapters.
- `src/stt/types.ts` - STT types.
- `src/stt/wavGuard.ts` - WAV header validation helpers.
- `src/stt/providers/disabled.ts` - disabled STT provider (no-op).
- `src/stt/providers/httpWavJson.ts` - WAV-over-HTTP STT provider.
- `src/stt/providers/whisperHttp.ts` - Whisper HTTP provider implementation.

### src/transport
- `src/transport/types.ts` - transport interfaces.
- `src/transport/pstnTelnyxTransport.ts` - PSTN transport using Telnyx call control.
- `src/transport/webrtcHdTransport.ts` - WebRTC HD transport (wrtc).

### src/tts
- `src/tts/kokoroTTS.ts` - Kokoro TTS HTTP client.
- `src/tts/types.ts` - TTS request/response types.

### src/storage
- `src/storage/audioStore.ts` - audio storage, URL building, cleanup.
- `src/storage/types.ts` - audio storage types.

### src/telnyx
- `src/telnyx/telnyxClient.ts` - Telnyx call control HTTP client and retries.
- `src/telnyx/telnyxVerify.ts` - webhook signature verification and metadata extraction.
- `src/telnyx/types.ts` - Telnyx payload types.

### src/types
- `src/types/wrtc.d.ts` - TypeScript definitions for `wrtc`.

### tests/
- `tests/testEnv.ts` - test env defaults for required vars.
- `tests/capacity.test.ts` - tests capacity key/behavior mapping.
- `tests/mediaIngest.test.ts` - tests track normalization and ingest health checks.
- `tests/sessionManager.test.ts` - tests session create/teardown flow.
- `tests/telnyxClient.test.ts` - tests Telnyx request payloads.
- `tests/telnyxVerify.test.ts` - tests webhook signature validation.
- `tests/wavGuard.test.ts` - tests WAV header guard.
