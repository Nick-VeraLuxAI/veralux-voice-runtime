# Redis Contract Consumption Report

Generated by `scripts/print_redis_contract.ts`.

## Scope
- Redis usage in `src/tenants/tenantResolver.ts` and `src/limits/capacity.ts`.
- No tenant runtime config (`tenantcfg`) loader found in `src/` or `dist/`.

## Redis-related environment variables
- `REDIS_URL` (required; startup throws if missing)
- `TENANTMAP_PREFIX` (default `tenantmap` when missing/blank)
- `CAP_PREFIX` (default `cap` when missing/blank)
- `GLOBAL_CONCURRENCY_CAP` (required)
- `TENANT_CONCURRENCY_CAP_DEFAULT` (required)
- `TENANT_CALLS_PER_MIN_CAP_DEFAULT` (required)
- `CAPACITY_TTL_SECONDS` (required)

## Tenant DID -> tenantId mapping
- Key format: `${TENANTMAP_PREFIX}:did:${normalized}`
- Normalization: `toNumber.trim().replace(/\s+/g, '')`
- Lookup: `GET` on the key; returns `tenantId` string or `null`.

## Capacity limiting keys
- Global active set: `${CAP_PREFIX}:global:active`
- Tenant active set: `${CAP_PREFIX}:tenant:${tenantId}:active`
- Tenant RPM counter: `${CAP_PREFIX}:tenant:${tenantId}:rpm:${YYYYMMDDHHmm}` (UTC timestamp; zero-padded year/month/day/hour/minute)
- Tenant concurrency cap override: `${TENANTMAP_PREFIX}:tenant:${tenantId}:cap:concurrency`
- Tenant RPM cap override: `${TENANTMAP_PREFIX}:tenant:${tenantId}:cap:rpm`

Read behavior:
- `cap:concurrency` and `cap:rpm` are read via `GET`. Values must parse to positive numbers; otherwise defaults are used.

Write behavior:
- Active sets are updated with `SADD`/`EXPIRE` (TTL = `CAPACITY_TTL_SECONDS`).
- RPM key is `INCR`'d and `EXPIRE`'d for 120 seconds when first created.

## Tenant runtime config (tenantcfg)
- No code found that reads a tenant JSON config from Redis (no `tenantcfg` key usage).
- Only per-tenant config read from Redis today is the two numeric cap overrides above; no JSON schema validation exists.

## Failure behaviors and logs
- DID mapping missing (`GET` returns null or normalized number is empty): `resolveTenantId` returns `null`; `call.initiated` plays "The number you dialed is not configured." then hangs up. No explicit log for missing mapping.
- Redis down during tenant mapping: `resolveTenantId` logs `tenant resolve failed`, then treats as missing mapping (same message + hangup).
- Tenantcfg missing: no loader, so no runtime behavior beyond capacity defaults.
- Redis down during capacity check:
  - `tryAcquire` logs `capacity evaluation failed` and throws.
  - `telnyxWebhook` logs `capacity check failed`, plays "We are unable to accept your call right now.", then hangs up.
- At capacity (script returns `global_at_capacity`, `tenant_at_capacity`, or `tenant_rate_limited`):
  - `tryAcquire` logs `capacity denied`.
  - `telnyxWebhook` plays "We are currently at capacity. Please try again later." then hangs up.
- Redis down during capacity release: logs `capacity release failed` but call teardown continues.
- HTTP behavior: webhook handler responds `200 { ok: true }` after enqueuing work (only invalid signature returns 401); failures are handled asynchronously and do not return 4xx/5xx to Telnyx.
- Redis client behavior: uses `maxRetriesPerRequest: 2` and `enableReadyCheck: true`; no explicit per-request timeout is set in code.
